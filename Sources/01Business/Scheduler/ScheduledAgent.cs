//*******************************************************************************************************************************
// DEBUT DU FICHIER
//*******************************************************************************************************************************

//*******************************************************************************************************************************
// Nom           : ScheduledAgent.cs
// Auteur        : Nicolas Dagnas
// Description   : Implémentation de l'objet ScheduledAgent
// Créé le       : 24/03/2015
// Modifié le    : 23/07/2015
//*******************************************************************************************************************************

//-------------------------------------------------------------------------------------------------------------------------------
#region Using directives
//-------------------------------------------------------------------------------------------------------------------------------
using System;
using System.Net;
using System.Linq;
using System.Text;
using System.Windows;
using System.Xml.Linq;
using System.Diagnostics;
using System.Globalization;
using System.Windows.Media;
using System.IO.IsolatedStorage;
using System.Collections.Generic;
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
using Newtonsoft.Json.Linq;
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
using Microsoft.Phone.Shell;
using Microsoft.Phone.Scheduler;
using Microsoft.Phone.Net.NetworkInformation;
//-------------------------------------------------------------------------------------------------------------------------------
#endregion
//-------------------------------------------------------------------------------------------------------------------------------

//*******************************************************************************************************************************
// Début du bloc "NextRadio.Scheduler"
//*******************************************************************************************************************************
namespace NextRadio.Scheduler
	{

    //   ####   ###   #   #  #####  ####   #   #  #      #####  #### 
    //  #      #   #  #   #  #      #   #  #   #  #      #      #   #
    //   ###   #      #####  ###    #   #  #   #  #      ###    #   #
    //      #  #   #  #   #  #      #   #  #   #  #      #      #   #
    //  ####    ###   #   #  #####  ####    ###   #####  #####  #### 

	//***************************************************************************************************************************
	// Classe ScheduledAgent
	//***************************************************************************************************************************
	#region // Déclaration et Implémentation de l'Objet
	//---------------------------------------------------------------------------------------------------------------------------
	/// <summary>
	/// Définit le comportement de l'agent.
	/// </summary>
	//---------------------------------------------------------------------------------------------------------------------------
	public class ScheduledAgent : ScheduledTaskAgent
		{
		//***********************************************************************************************************************
		#region // Classe FlipTileOptions
		//-----------------------------------------------------------------------------------------------------------------------
		class FlipTileOptions
			{
			//*******************************************************************************************************************
			/// <summary>
			/// Obtiens la configuration de la tuile celon son type.
			/// </summary>
			/// <param name="Tile"></param>
			/// <returns></returns>
			//-------------------------------------------------------------------------------------------------------------------
			public static FlipTileOptions FromTile ( ShellTile Tile )
				{
				//---------------------------------------------------------------------------------------------------------------
				return FlipTileOptions.FromUri ( Tile.NavigationUri );
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************

			//*******************************************************************************************************************
			/// <summary>
			/// Obtiens la configuration de la tuile celon son type.
			/// </summary>
			/// <param name="Uri"></param>
			/// <returns></returns>
			//-------------------------------------------------------------------------------------------------------------------
			public static FlipTileOptions FromUri ( Uri Uri )
				{
				//---------------------------------------------------------------------------------------------------------------
				switch ( Uri.OriginalString )
					{
					//-----------------------------------------------------------------------------------------------------------
					#region // Bookmarks
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Bookmarks" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "01Business"                               ,
							BackTitle               = "01Business"                               ,
							SectionID               = 0                                          ,
							SmallBackgroundImage    = "Assets/Tiles/Bookmarks/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Bookmarks/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Bookmarks/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Bookmarks/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Bookmarks/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					#region // Internet
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Technology" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "01Business"                                ,
							BackTitle               = "01Business"                                ,
							SectionID               = 11410                                       ,
							SubSectionID            = 10016                                       ,
							SmallBackgroundImage    = "Assets/Tiles/Technology/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Technology/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Technology/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Technology/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Technology/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Products
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Products" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "01Business"                              ,
							BackTitle               = "01Business"                              ,
							SectionID               = 10398                                     ,
							SubSectionID            = 0                                         ,
							SmallBackgroundImage    = "Assets/Tiles/Products/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Products/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Products/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Products/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Products/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Security
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Security" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "01Business"                              ,
							BackTitle               = "01Business"                              ,
							SectionID               = 10005                                     ,
							SubSectionID            = 0                                         ,
							SmallBackgroundImage    = "Assets/Tiles/Security/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Security/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Security/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Security/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Security/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Service
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Service" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "01Business"                             ,
							BackTitle               = "01Business"                             ,
							SectionID               = 11410                                    ,
							SubSectionID            = 10023                                    ,
							SmallBackgroundImage    = "Assets/Tiles/Service/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Service/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Service/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Service/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Service/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Telecoms
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Telecoms" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "01Business"                              ,
							BackTitle               = "01Business"                              ,
							SectionID               = 11410                                     ,
							SubSectionID            = 10019                                     ,
							SmallBackgroundImage    = "Assets/Tiles/Telecoms/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Telecoms/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Telecoms/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Telecoms/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Telecoms/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				
				//---------------------------------------------------------------------------------------------------------------
				return new FlipTileOptions ()
					{
					//-----------------------------------------------------------------------------------------------------------
					Title                   = string.Empty                     ,
					BackTitle               = string.Empty                     ,
					SectionID               = 0                                ,
					SubSectionID            = 0                                ,
					SmallBackgroundImage    = "Assets/Tiles/FlipTileSmall.png" ,
					BackgroundImage         = "Assets/Tiles/FlipTileMedium.png",
					WideBackgroundImage     = "Assets/Tiles/FlipTileWide.png"  ,
					BackBackgroundImage     = "Assets/Tiles/BackTileMedium.png",
					WideBackBackgroundImage = "Assets/Tiles/BackTileWide.png"  ,
					//-----------------------------------------------------------------------------------------------------------
					};
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************

			//-------------------------------------------------------------------------------------------------------------------
			public string Title                   { get; private set; }
			public string BackTitle               { get; private set; }
			public int    SectionID               { get; private set; }
			public int    SubSectionID            { get; private set; }
			public string SmallBackgroundImage    { get; private set; }
			public string BackgroundImage         { get; private set; }
			public string WideBackgroundImage     { get; private set; }
			public string BackBackgroundImage     { get; private set; }
			public string WideBackBackgroundImage { get; private set; }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Structure FlipTileInfos
		//-----------------------------------------------------------------------------------------------------------------------
		struct FlipTileInfos
			{
			//-------------------------------------------------------------------------------------------------------------------
			public string   Title        { get; set; }
			public DateTime PublishDate  { get; set; }
			public int      SectionID    { get; set; }
			public int      SubSectionID { get; set; }
			public string   ArticleID    { get; set; }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Classe DownloadDataState
		//-----------------------------------------------------------------------------------------------------------------------
		class DownloadDataState
			{
			//*******************************************************************************************************************
			/// <summary>
			/// 
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public DownloadDataState ()
				{
				//---------------------------------------------------------------------------------------------------------------
				Items = new List<FlipTileInfos> ();

				this.LastAppLaunch  = StorageSettings.GetValue ( "agent-last-app-launch" , 
				                                                               DateTime.MinValue );
				this.LastToastCheck = StorageSettings.GetValue ( "agent-last-toast-check", 
				                                                               DateTime.MinValue );

				this.CheckToast = ( ScheduledAgent.ToastDelay > 0 && DateTime.Now.Subtract 
				                       ( LastToastCheck ).TotalHours > ScheduledAgent.ToastDelay );
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************
			
			//-------------------------------------------------------------------------------------------------------------------
			public bool                CheckToast     { get; private set; }
			public DateTime            LastAppLaunch  { get; private set; }
			public DateTime            LastToastCheck { get; private set; }
			public List<FlipTileInfos> Items          { get; private set; }
			//-------------------------------------------------------------------------------------------------------------------

			//*******************************************************************************************************************
			/// <summary>
			/// Prévient que le processus est finit.
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public void NotifyComplete ()
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( this.CheckToast )
					StorageSettings.SetValue ( "agent-last-toast-check", DateTime.Now );
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		// Section des Constantes
		//-----------------------------------------------------------------------------------------------------------------------
		private const string UserAgent = "01Business 3 (Android; Android OS 4.0.0; fr_FR)";
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		#region // Section du Constructeur
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		/// <remarks>
		/// Le constructeur ScheduledAgent initialise le gestionnaire UnhandledException.
		/// </remarks>
		//-----------------------------------------------------------------------------------------------------------------------
		static ScheduledAgent ()
			{
			//-------------------------------------------------------------------------------------------------------------------
			Deployment.Current.Dispatcher.BeginInvoke ( delegate 
			                   { Application.Current.UnhandledException += UnhandledException; } );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Se produit quand une exception est générée.
		/// </summary>
		/// <param name="Sender">Objet source de l'appel.</param>
		/// <param name="Args">
		/// <b>ApplicationUnhandledExceptionEventArgs</b> qui contient les données d'événement.
		/// </param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void UnhandledException ( object Sender, ApplicationUnhandledExceptionEventArgs Args )
			{
			//-------------------------------------------------------------------------------------------------------------------
			Args.Handled = true;
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		#region // Section des Procédures Privées
		//-----------------------------------------------------------------------------------------------------------------------
		
		//***********************************************************************************************************************
		/// <summary>
		/// Découpe la chaine en plusieurs chaines plus petites
		/// </summary>
		/// <param name="Value">Chaine à découper.</param>
		/// <returns>Chaine découpée.</returns>
		//-----------------------------------------------------------------------------------------------------------------------
		private static string WordWrap ( string Value, int Size, int MaxLines )
			{
			//-------------------------------------------------------------------------------------------------------------------
			int LastWhiteSpace = -1;
			var Buffer         = new StringBuilder ();
			var Result         = new StringBuilder ();
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			for ( int Index = 0 ; Index < Value.Length && MaxLines > 0 ; Index ++ )
				{
				//---------------------------------------------------------------------------------------------------------------
				char Car = Value[Index];

				if ( Char.IsWhiteSpace ( Car ) ) LastWhiteSpace = Index;

				Buffer.Append ( Car );
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				if ( Buffer.Length >= Size && LastWhiteSpace > -1 )
					{
					//-----------------------------------------------------------------------------------------------------------
					if ( MaxLines > 0 )
						{
						//-------------------------------------------------------------------------------------------------------
						Result.Append ( Buffer.ToString ( 0, LastWhiteSpace ) );

						if ( MaxLines > 1 )
							{
							Result.Append ( "&#13;" );
							}
						else
							{
							if ( Index == Value.Length ) Result.Append ( "."     );
							else                         Result.Append ( " ..."  );
							}

						Buffer = new System.Text.StringBuilder ();

						Index  = -1;
						MaxLines --;

						Value = Value.Substring ( LastWhiteSpace + 1 );
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					}
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			if ( Buffer.Length > 0 && MaxLines > 0 ) Result.Append ( Buffer.ToString () );

			string FinalResult = Result.ToString ();

			if ( ! FinalResult.EndsWith ( "." ) ) FinalResult += ".";

			return FinalResult;
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		#region // Section de Gestion de la Tuile
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		/// <summary>
		/// Gère l'affichage final de la tuile.
		/// </summary>
		/// <param name="Tile">Tuile à mettre à jour.</param>
		/// <param name="Images">Configuration de la tuile.</param>
		/// <param name="Content">Texte à afficher.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static FlipTileData GetTileData ( FlipTileOptions Config, string Content )
			{
			//-------------------------------------------------------------------------------------------------------------------
			string XmlContent = String.Empty;
			//-------------------------------------------------------------------------------------------------------------------
				
			//-------------------------------------------------------------------------------------------------------------------
			string TitleClear     = ( string.IsNullOrEmpty ( Config.Title     ) ) ? "Action=\"Clear\"" : "";
			string BackTitleClear = ( string.IsNullOrEmpty ( Config.BackTitle ) ) ? "Action=\"Clear\"" : "";
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			// Tuile avec article
			//-------------------------------------------------------------------------------------------------------------------
			if ( string.IsNullOrEmpty ( Content ) )
				{
				//---------------------------------------------------------------------------------------------------------------
				#region // Déclaration du corp
				//---------------------------------------------------------------------------------------------------------------
				XmlContent = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"                                   +
					         "<wp:Notification xmlns:wp=\"WPNotification\" Version=\"2.0\">\n"                +
					         " <wp:Tile Id=\"1\" Template=\"FlipTile\">\n"                                    +
					         "  <wp:Count>0</wp:Count>\n"                                                     +
					         "  <wp:Title {0}>{1}</wp:Title>\n"                                               +
					         "  <wp:SmallBackgroundImage IsRelative=\"true\">{2}</wp:SmallBackgroundImage>\n" +
					         "  <wp:BackgroundImage IsRelative=\"true\">{3}</wp:BackgroundImage>\n"           +
					         "  <wp:WideBackgroundImage IsRelative=\"true\">{4}</wp:WideBackgroundImage>\n"   +
					         "  <wp:BackTitle Action=\"Clear\" />\n"                                          +
					         "  <wp:BackContent Action=\"Clear\" />\n"                                        +
					         "  <wp:WideBackContent Action=\"Clear\" />\n"                                    +
					         "  <wp:BackBackgroundImage IsRelative=\"true\" Action=\"Clear\" />\n"            +
					         "  <wp:WideBackBackgroundImage IsRelative=\"true\" Action=\"Clear\" />\n"        +
					         " </wp:Tile>\n"                                                                  +
					         "</wp:Notification>";

				XmlContent = string.Format ( XmlContent, TitleClear                 , 
					                                     Config.Title               , 
					                                     Config.SmallBackgroundImage, 
					                                     Config.BackgroundImage     , 
					                                     Config.WideBackgroundImage );
				//---------------------------------------------------------------------------------------------------------------
				#endregion
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			// Tuile sans article
			//-------------------------------------------------------------------------------------------------------------------
			else
				{
				//---------------------------------------------------------------------------------------------------------------
				#region // Déclaration du corp
				//---------------------------------------------------------------------------------------------------------------
				XmlContent = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"                                          +
					         "<wp:Notification xmlns:wp=\"WPNotification\" Version=\"2.0\">\n"                       +
					         " <wp:Tile Id=\"1\" Template=\"FlipTile\">\n"                                           +
					         "  <wp:Count>0</wp:Count>\n"                                                            +
					         "  <wp:Title {0}>{1}</wp:Title>\n"                                                      +
					         "  <wp:SmallBackgroundImage IsRelative=\"true\">{2}</wp:SmallBackgroundImage>\n"        +
					         "  <wp:BackgroundImage IsRelative=\"true\">{3}</wp:BackgroundImage>\n"                  +
					         "  <wp:WideBackgroundImage IsRelative=\"true\">{4}</wp:WideBackgroundImage>\n"          +
					         "  <wp:BackTitle {5}>{6}</wp:BackTitle>\n"                                              +
					         "  <wp:BackContent>{7}</wp:BackContent>\n"                                              +
					         "  <wp:WideBackContent>{8}</wp:WideBackContent>\n"                                      +
					         "  <wp:BackBackgroundImage IsRelative=\"true\">{9}</wp:BackBackgroundImage>\n"          +
					         "  <wp:WideBackBackgroundImage IsRelative=\"true\">{10}</wp:WideBackBackgroundImage>\n" +
					         " </wp:Tile>\n" +
					         "</wp:Notification>";
					
				XmlContent = string.Format ( XmlContent, TitleClear                     , 
					                                     Config.Title                   , 
					                                     Config.SmallBackgroundImage    , 
					                                     Config.BackgroundImage         , 
					                                     Config.WideBackgroundImage     ,
					                                     BackTitleClear                 , 
					                                     Config.BackTitle               , 
					                                     Content                        , 
					                                     WordWrap ( Content, 26, 3 )    ,
					                                     Config.BackBackgroundImage     ,
					                                     Config.WideBackBackgroundImage );
				//---------------------------------------------------------------------------------------------------------------
				#endregion
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			return new FlipTileData ( XmlContent );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Purge la tuile.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void ClearTiles ()
			{
			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				Deployment.Current.Dispatcher.BeginInvoke ( () =>
					{
					//-----------------------------------------------------------------------------------------------------------
					foreach ( ShellTile Tile in ShellTile.ActiveTiles )	
						{ ScheduledAgent.ClearTile ( Tile, FlipTileOptions.FromTile ( Tile ) ); }
					//-----------------------------------------------------------------------------------------------------------
					} );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Gère l'affichage final de la tuile.
		/// </summary>
		/// <param name="Tile">Tuile à mettre à jour.</param>
		/// <param name="Images">Configuration de la tuile.</param>
		/// <param name="Content">Texte à afficher.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void ClearTile ( ShellTile Tile, FlipTileOptions Images )
			{
			//-------------------------------------------------------------------------------------------------------------------
			ScheduledAgent.UpdateTile ( Tile, Images, string.Empty );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Gère l'affichage final de la tuile.
		/// </summary>
		/// <param name="Tile">Tuile à mettre à jour.</param>
		/// <param name="Images">Configuration de la tuile.</param>
		/// <param name="Content">Texte à afficher.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void UpdateTile ( ShellTile Tile, FlipTileOptions Config, string Content )
			{
			//-------------------------------------------------------------------------------------------------------------------
			try { Tile.Update ( GetTileData ( Config, Content ) ); } catch {}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************
		
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Section des Procédures de Traitement
		//-----------------------------------------------------------------------------------------------------------------------
		
		//***********************************************************************************************************************
		/// <summary>
		/// Met à jour les tuiles et lance les notifications.
		/// </summary>
		/// <param name="State">Object ontenant les informations à traiter.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private void OnFinalProcess ( DownloadDataState State )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			Deployment.Current.Dispatcher.BeginInvoke ( () =>
				{
				//---------------------------------------------------------------------------------------------------------------
				// On a du contenue, on récupère la liste des Tuiles
				//---------------------------------------------------------------------------------------------------------------
				var Tiles = new Dictionary<ShellTile, FlipTileOptions> ();

				if ( ScheduledAgent.TileIsActive )
					foreach ( ShellTile Tile in ShellTile.ActiveTiles )
						{ Tiles[Tile] = FlipTileOptions.FromTile ( Tile ); }
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				int           ToastCount   = 0;
				FlipTileInfos ToastContent = new FlipTileInfos ();
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				try
					{
					//-----------------------------------------------------------------------------------------------------------
					// Lecture des Eléments
					//-----------------------------------------------------------------------------------------------------------
					foreach ( FlipTileInfos Item in State.Items )
						{
						//-------------------------------------------------------------------------------------------------------
						var ProcessedTiles = new List <ShellTile> ();

						foreach ( ShellTile Tile in Tiles.Keys )
							{
							FlipTileOptions TileInfos = Tiles[Tile];

							if ( TileInfos.SectionID == 0 || TileInfos.SectionID == Item.SectionID )
								{
								if ( TileInfos.SubSectionID == 0 || TileInfos.SubSectionID == Item.SubSectionID )
									{
									ScheduledAgent.UpdateTile ( Tile, Tiles[Tile], Item.Title );

									ProcessedTiles.Add ( Tile );
									}
								}
							}

						foreach ( ShellTile Tile in ProcessedTiles ) { Tiles.Remove ( Tile ); }
						//-------------------------------------------------------------------------------------------------------

						//-------------------------------------------------------------------------------------------------------
						// Est ce qu'on check les Toast ?
						//-------------------------------------------------------------------------------------------------------
						if ( State.CheckToast && Item.PublishDate > State.LastToastCheck )
							{
							//---------------------------------------------------------------------------------------------------
							ToastCount ++;
							ToastContent = Item;
							//---------------------------------------------------------------------------------------------------
							}
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				catch {}
				//---------------------------------------------------------------------------------------------------------------
				finally
					{
					//-----------------------------------------------------------------------------------------------------------
					#region // Un nouvel article
					//-----------------------------------------------------------------------------------------------------------
					if ( ToastCount == 1 )
						{
						//-------------------------------------------------------------------------------------------------------
						(new ShellToast ()
							{
							Title         = "Nouvel article"                                      ,
							Content       = ToastContent.Title                                    ,
							NavigationUri = new Uri ( "/Frames/Frm_Home.xaml?Article="            + 
							                            ToastContent.ArticleID, UriKind.Relative ),
							}).Show ();
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					#region // Plusieurs nouveaux articles
					//-----------------------------------------------------------------------------------------------------------
					else if ( ToastCount > 1 )
						{
						//-------------------------------------------------------------------------------------------------------
						(new ShellToast ()
							{
							Title         = "01Business"                                         ,
							Content       = string.Format ( "tu as {0} nouveaux articles"        +
							                               " à lire sur 01Business", ToastCount ),
							NavigationUri = new Uri ( "/Frames/Frm_Home.xaml", UriKind.Relative ),
							}).Show ();
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					
					//-----------------------------------------------------------------------------------------------------------
					// On ré-initialise les tuiles non mise à jour
					//-----------------------------------------------------------------------------------------------------------
					foreach ( ShellTile Tile in Tiles.Keys )
						{ ScheduledAgent.ClearTile ( Tile, Tiles[Tile] ); }

					State.NotifyComplete ();
					base .NotifyComplete ();
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				} );
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Gère la réponse à la récupération des derniers articles.
		/// </summary>
		/// <param name="Sender">Objet source de l'appel.</param>
		/// <param name="Args"><b>...EventArgs</b> qui contient les données d'événement.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private void OnGetLastArticlesSuccess ( object S, DownloadStringCompletedEventArgs Args )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------
			
			//-------------------------------------------------------------------------------------------------------------------
			DownloadDataState State = (DownloadDataState)Args.UserState;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				// S'il y a eu une erreur ou une exception, on arrête
				//---------------------------------------------------------------------------------------------------------------
				if ( Args.Cancelled                       ) return;
				if ( Args.Error                   != null ) return;
				if ( string.IsNullOrEmpty ( Args.Result ) ) return;
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				JToken Racine = JToken.Parse ( Args.Result );

				if ( Racine == null || ! Racine.HasValues ) return;

				var Articles = Racine["articles"];
			
				if ( Articles == null ) return;
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				// Lecture des Articles
				//---------------------------------------------------------------------------------------------------------------
				var Article = Articles.First;

				while ( Article != null )
					{
					//-----------------------------------------------------------------------------------------------------------
					string Title = HttpUtility.HtmlDecode ( Article.Value<string>( "title" ) );

					string ArticleID    = Article.Value<string>( "article"       );
					int    SectionID    = Article.Value<int   >( "section_id"    );
					int    SubSectionID = 0;

					try
						{
						if ( ((JValue)Article.Value<object>( "subsection_id" )).Value != null )
							SubSectionID = Article.Value<int>( "subsection_id" );
						}
					catch {}

					DateTime Date     = Article.Read<DateTime>( "date"      );
					DateTime EditDate = Article.Read<DateTime>( "edit_date" );

					DateTime PublishDate = ( EditDate > Date ) ? EditDate : Date;

					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					if ( PublishDate >= State.LastAppLaunch )
						{
						//-------------------------------------------------------------------------------------------------------
						State.Items.Add ( new FlipTileInfos ()
							{
							Title        = Title       ,
							PublishDate  = PublishDate ,
							SectionID    = SectionID   ,
							SubSectionID = SubSectionID,
							ArticleID    = ArticleID   ,
							} );
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					Article = Article.Next;
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			finally { this.OnFinalProcess ( State ); }
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Récupère les derniers articles publiés.
		/// </summary>
		/// <param name="Token"></param>
		/// <returns></returns>
		//-----------------------------------------------------------------------------------------------------------------------
		private bool AsyncGetLastArticles ( DownloadDataState State, string Token )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				string Uri = "http://api.nextradiotv.com/01business-android/{0}/getArticlesList";

				var WebClient = new WebClient ();

				WebClient.Headers["User-Agent"] = UserAgent;

				WebClient.DownloadStringCompleted += this.OnGetLastArticlesSuccess;

				WebClient.DownloadStringAsync ( new Uri ( string.Format ( Uri, Token ) ), State );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch { return false; }
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			return true;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Gère la réponse à l'enregistrement.
		/// </summary>
		/// <param name="Sender">Objet source de l'appel.</param>
		/// <param name="Args"><b>...EventArgs</b> qui contient les données d'événement.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private void OnRegistationSuccess ( object S, DownloadStringCompletedEventArgs Args )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			bool CancelNotify = false;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				// S'il y a eu une erreur ou une exception, on arrête
				//---------------------------------------------------------------------------------------------------------------
				if ( Args.Cancelled                       ) return;
				if ( Args.Error                   != null ) return;
				if ( string.IsNullOrEmpty ( Args.Result ) ) return;
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				DownloadDataState State = (DownloadDataState)Args.UserState;
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				JToken Racine = JToken.Parse ( Args.Result );

				if ( Racine == null || ! Racine.HasValues ) return;

				JToken Session = Racine["session"];

				if ( Session == null || ! Session.HasValues ) return;
				//---------------------------------------------------------------------------------------------------------------

				CancelNotify = this.AsyncGetLastArticles ( State, Session.Value<string>("token") );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			finally { if ( ! CancelNotify ) base.NotifyComplete (); }
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Enregistre l'agent au près du service.
		/// </summary>
		/// <returns>
		/// <b>True</b> si aucune anomalie n'est apparu lors de l'appel, sinon <b>False</b>.
		/// </returns>
		//-----------------------------------------------------------------------------------------------------------------------
		private bool AsyncRegisterApp ( DownloadDataState State )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				string Uri = "http://api.nextradiotv.com/01business-android/";

				var WebClient = new WebClient ();

				WebClient.Headers["User-Agent"] = UserAgent;

				WebClient.DownloadStringCompleted += this.OnRegistationSuccess;

				WebClient.DownloadStringAsync ( new Uri ( Uri ), State );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch { return false; }
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			return true;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Agent qui exécute une tâche planifiée.
		/// </summary>
		/// <param name="task">La tâche appelée.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		protected override void OnInvoke ( ScheduledTask task )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			bool CancelNotify = false;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( ! TileIsActive && ToastDelay == 0           ) return;
				if ( ! NetworkInterface.GetIsNetworkAvailable () ) return;

				CancelNotify = this.AsyncRegisterApp ( new DownloadDataState () );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			finally
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( ! CancelNotify )
					{
					//-----------------------------------------------------------------------------------------------------------
					base.NotifyComplete       ();
					ScheduledAgent.ClearTiles ();
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************
		
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // PROCEDURE >> Clear
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Purge la tuile.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static void Clear ()
			{
			//-------------------------------------------------------------------------------------------------------------------
			StorageSettings.SetValue ( "agent-last-app-launch" , DateTime.Now                    );
			StorageSettings.SetValue ( "agent-last-toast-check", DateTime.Now.AddMinutes ( -30 ) );
			
			ScheduledAgent.ClearTiles ();
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		#region // PROCEDURE >> GetTileData
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Obtiens les infos nécessaires à la création de la tuile.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static FlipTileData GetTileData ( Uri Uri )
			{
			//-------------------------------------------------------------------------------------------------------------------
			var TileConfig = FlipTileOptions.FromUri ( Uri );
				
			return ScheduledAgent.GetTileData ( TileConfig, string.Empty );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // PROPERTY >> TileIsActive
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Indique si la tuile dynamique est active.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static bool TileIsActive
			{
			//-------------------------------------------------------------------------------------------------------------------
			get { return (bool)StorageSettings.GetValue ( "agent-tile-is-active", false ); }
			set {              StorageSettings.SetValue ( "agent-tile-is-active", value ); }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // PROPERTY >> ToastDelay
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Indique si les notifications sont actives.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static int ToastDelay
			{
			//-------------------------------------------------------------------------------------------------------------------
			get
				{
				object Value = StorageSettings.GetValue ( "agent-toast-delay" );

				if ( Value == null )
					{
					bool Active = StorageSettings.GetValue ( "agent-toast-is-active", false );

					Value = ( Active ) ? (int)1 : (int)0;

					StorageSettings.SetValue ( "agent-toast-delay", (int)Value );
					}
				
				return (int)Value;
				}
			//-------------------------------------------------------------------------------------------------------------------
			set
				{
				//---------------------------------------------------------------------------------------------------------------
				switch ( value )
					{
					case 1  : StorageSettings.SetValue ( "agent-toast-delay", value ); break;
					case 2  : StorageSettings.SetValue ( "agent-toast-delay", value ); break;
					case 4  : StorageSettings.SetValue ( "agent-toast-delay", value ); break;
					default : StorageSettings.SetValue ( "agent-toast-delay", 0     ); break;
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		}
	//---------------------------------------------------------------------------------------------------------------------------
	#endregion
	//***************************************************************************************************************************

	} // Fin du namespace "NextRadio.Scheduler"
//*******************************************************************************************************************************

//*******************************************************************************************************************************
// FIN DU FICHIER
//*******************************************************************************************************************************
